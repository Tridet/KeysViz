<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="./functions/stroke2dict.js"></script>
	<script src="./functions/stroke2freq.js"></script>
	<style>
		rect.bordered {
				stroke: #E6E6E6;
				stroke-width:4px;   
			}
		body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
	</style>
</head>

<body>
	<script>
		var margin = { top: 50, right: 30, bottom: 50, left: 30 },
					width = window.innerWidth - margin.left - margin.right,
					height = window.innerHeight - margin.top - margin.bottom;

		var svg = d3.select("body").append("svg")
					.attr("width", width)
					.attr("height", height)
					//.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
		var data;
		var freq;
		var height2 = width / 3;

		var color = d3.scaleSqrt().range(['#FFFFFF', '#fa8072']).interpolate(d3.interpolateRgb);
		
		d3.json('https://raw.githubusercontent.com/Tridet/KeysViz/master/data/Loic/keyboard_display.json', function(json) {
			data = json;
			//console.log(data);
			d3.text('https://raw.githubusercontent.com/Tridet/KeysViz/master/data/pascal/logs_js.txt', function(raw){

				var dsv = d3.dsvFormat(';');
				freq = dsv.parse(raw);
				freq.forEach(function(d) {
					d["stroke"] = d["stroke"].toString();
				});
				freq = stroke2dict(freq, 50);
				var dmax = 0;
				for (var k in freq) {
					if (dmax < freq[k]) {
						dmax = freq[k];
					}
				}
				color.domain([0, dmax]);
				console.log(freq)
				
				svg.selectAll("rect").data(data).enter()
					.append("rect")
					.attr("x", function(d,i) {return width*d.start;})
					.attr("y", function(d,i) {return height2*d.nb/5;})
					.attr("width", function(d,i) {return  width*d.rat;})
					.attr("height", function(d,i) {return height2/5;})
					.attr("fill", function(d,i) {
						if (freq[d.v.toLowerCase()] == undefined) {
							var c = color(0);
						}
						else {
							var c = color(freq[d.v.toLowerCase()]);
						}
						return c;
					})
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("class", "hour bordered")
				
				svg.selectAll("text").data(data).enter()
					.append("text")
					.attr("y", function(d) {return height2*d.nb/5 + height2/9;})
					.attr("x", function(d) {return width*(d.start + d.rat/2);})
					.attr("font-size", 17)
					.attr("font-family", "monospace")
					.text(function(d) {return d.v})
					.attr("fill", "black")
					.attr("text-anchor", "middle")
			})
		})
		
	</script>
</body>