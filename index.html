<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
        .line {
      fill: none;
      stroke: black;
      stroke-width: 1.5px;
    }
    .line {
    fill: none;
    stroke: #ffab00;
    stroke-width: 1.5;
}
  </style>
</head>
  <!--
  <svg width=600 height=600>
    <rect style="x:100;y:150;width:50;height:100;"></rect>
    <rect style="x:200;y:50;width:50;height:200;"></rect>
    <rect style="x:300;y:170;width:50;height:80;"></rect>
  </svg>
  -->
<body>
  <script>
    
    //1. Créer le SVG
    var svg = d3.select("body")
    .append("svg")
    .attr("width",1200)
    .attr("height",600)
    
    //2. Générer les données
//     var data=d3.range(100);
    var long=800,larg=350,offset_up=400;
    // Aesthetic
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    
    var symbolos = d3.scaleOrdinal(d3.symbols);
    var symbol = d3.symbol().size(70); 
    
    parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S,%L "); //noter l'espace final
//     console.log(parseDate("2019-01-29 10:28:05,248"));
    
    d3.dsv(";",'log_29_01').then(function(data){
     data.forEach(function(d) {
     d.keys = d.keys;
     d["date"] = parseDate(d["date"]);
     });
      
//     console.log(data[0])
     
      var keys = d3.nest()
      .key(function(d) { return d.keys; })
      .entries(data);
      
     	keys.sort(function(x, y){
     		return d3.descending(x.values.length, y.values.length);
})
//      console.log(keys[5])
     
      var formatMin = d3.timeFormat("%Y-%m-%d %H:%M")
      
      var by_min = d3.nest()
      .key(function(d){return formatMin(d["date"]);})
      .entries(data)

      
    //3. Data binding
//     var max_price = d3.max(by_year,function(d){return d.values.sumPrice})
      var max_key = keys[0].values.length
    
//      console.log(keys[0])
    
    var y = d3.scaleLinear()
        .domain([0, max_key])
        .range([0,larg]);

    var x = d3.scaleBand()
        .domain(d3.range(keys.length))  // nombre de touches
        .range([50, long], 0.2);


    var color = d3.scaleOrdinal()
      .range(d3.schemeCategory10);


      svg.selectAll("rect")
    			.data(keys)
      .enter().append("rect")
        .attr("width", x.bandwidth())
        .attr("height", function(d){return y(d.values.length); })
        .attr("x", function(d,i) { return x(i); })
    		.attr("y",function(d){return offset_up - y(d.values.length); })
   			.style("fill", function(d, i) { return color(i); })
    
     svg.selectAll("leg").data(keys).enter()
    .append("text")
     .text(function(d){return d.key})
//     .attr("x", function(d,i) { return 20; })
    .attr("y",function(d){return 10; })
    .style("text-anchor", "end")
    .attr("transform", function(d,i) {return "translate("+x(i)+"," +offset_up+")"+"rotate(-90)"  })
//     .style("fill", function(d, i) { return color(i); })

    
    })
    
  </script>
</body>
