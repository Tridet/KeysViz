<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script src="web_underscore.js"></script>
	<script src="./functions/chord_mapper.js"></script>
	<style>
		body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
		
	</style>
</head>

<body>
	<script>
		d3.csv('https://raw.githubusercontent.com/Tridet/KeysViz/master/data/Loic/logs_mail.csv', function(error, data) {
			var mpr = chordMpr(data);
			mpr
				.addValuesToMap('son')
				.setFilter(function(row, a, b) {
					return (row.father === a.name && row.son === b.name)
				})
				.setAccessor(function(recs, a, b) {
					if (!recs[0]) return 0;
					return +recs[0].count;
				});
			drawChords(mpr.getMatrix(), mpr.getMap());
		});

		function drawChords(matrix, mmap) {
			//console.log(matrix)
			var w = 950,
				h = 600,
				r1 = h / 2 ,
				r0 = r1 - 70;

			var chord = d3.chord()
				.padAngle(0.05)
				.sortSubgroups(d3.descending)
				.sortChords(d3.descending);

			var arc = d3.arc()
				.innerRadius(r0)
				.outerRadius(r0 + 20);

			var ribbon = d3.ribbon()
				.radius(r0);

			var svg = d3.select("body").append("svg:svg")
				.attr("width", w)
				.attr("height", h)
				.append("svg:g")
				.attr("id", "circle")
				.attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")
				.datum(chord(matrix));

			svg.append("circle")
				.attr("r", r0 + 20)
				.attr("fill", "none");

			var mapReader = chordRdr(matrix, mmap);

			var colors = d3.scaleOrdinal(d3.schemeCategory20c);


			var g = svg.selectAll("g.group")
				.data(function(chords) {
					return chords.groups;
				})
				.enter().append("svg:g")
				.attr("class", "group")

			g.append("svg:path")
				.style("stroke", "white")
				.style("fill", function(d, i) {console.log(mapReader(d).gname);
					if(i<6){return colors(1);}
						else{
					return colors(2);}
				})
				.attr("d", arc)
				.on("mouseenter",function(d,i){
					d3.select("svg").selectAll("path.chord")
					.style("fill",function(f,g){
					if(f.source.index==i || f.target.index==i){
						return colors(1);}
					else{return colors(0);}
					})})
				.on("mouseleave",function(d,i){
					d3.select("svg").selectAll("path.chord")
					.style("fill",function(f,g){
					return colors(0);
					})});
				

			g.append("svg:text")
				.each(function(d) {
					d.angle = (d.startAngle + d.endAngle) / 2;
				})
				.attr("dy", ".35em")
				.style("font-size", 13)
				.style("font-family", "monospace")
				.attr("text-anchor", function(d) {
					return d.angle > Math.PI ? "end" : null;
				})
				.attr("transform", function(d) {
					return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
						"translate(" + (r0 + 26) + ")" +
						(d.angle > Math.PI ? "rotate(180)" : "");
				})
				.text(function(d) {
				return mapReader(d).gname;
			});

			var chordPaths = svg.selectAll("path.chord")
				.data(function(chords) {
					return chords;
				})
				.enter().append("svg:path")
				.attr("class", "chord")
				.style("stroke", "white")
				.style("fill", function(d, i) {
					return colors(0);
				})
				.attr("d", ribbon.radius(r0))
				.on("mouseenter", function(d) {
						d3.select("svg").selectAll("path.chord")
							.attr("opacity", function(e) {
								return e === d ? 1: .1; 
						})
				})
				.on("mouseleave", function(d) {
						d3.select("svg").selectAll("path.chord")
							.attr("opacity", 1)
				});
			}

	</script>
</body>
