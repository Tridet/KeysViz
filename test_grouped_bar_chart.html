<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
        .line {
      fill: none;
      stroke: black;
      stroke-width: 1.5px;
    }
    .line {
    fill: none;
    stroke: #ffab00;
    stroke-width: 1.5;
}
  </style>
</head>
  <!--
  <svg width=600 height=600>
    <rect style="x:100;y:150;width:50;height:100;"></rect>
    <rect style="x:200;y:50;width:50;height:200;"></rect>
    <rect style="x:300;y:170;width:50;height:80;"></rect>
  </svg>
  -->
<body>
  <script>
    
    //1. Créer le SVG
    var svg = d3.select("body")
    .append("svg")
    .attr("width",1200)
    .attr("height",600)
    
    //2. Générer les données
//     var data=d3.range(100);
    var long=800,larg=350,offset_up=400;
    // Aesthetic
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    
    var symbolos = d3.scaleOrdinal(d3.symbols);
    var symbol = d3.symbol().size(70);  
    
    parseDate = d3.timeParse("%b %Y");
    // console.log(parseDate("Jan 2000"));
    
    d3.csv('stocks.csv').then(function(data){
     data.forEach(function(d) {
     d.symbol = d.symbol;
     d["date"] = parseDate(d["date"]);
     d.price = +d.price;
     });
      
      var symbols = d3.nest()
      .key(function(d) { return d.symbol; })
      .entries(data);

      var formatYear = d3.timeFormat("%Y")

// 			console.log(symbols)
      
      var by_year = d3.nest()
      .key(function(d){return formatYear(d["date"])})
      .entries(data)
      
      by_year.forEach(function(s) {

        s.sumPrice = d3.sum(s.values, function(d) { return d.price; });

      });
      
      
    //3. Data binding
    var max_price = d3.max(by_year,function(d){return d.sumPrice})
    
//     console.log(max_price)
    
    var y = d3.scaleLinear()
        .domain([0, max_price])
        .range([larg, 0]);

    var x0 = d3.scaleBand()
        .domain(d3.range(11))  // les données sont sur 10 ans
        .range([0, long], .2);

    var x1 = d3.scaleBand()
        .domain(d3.range(4)) // il y a 4 entreprises
        .range([0, x0.bandwidth() - 10]);

    var z = d3.scaleOrdinal()
      .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
    
    svg.append("g").selectAll("g")
        .data(symbols)
      .enter().append("g")
        .style("fill", function(d, i) { return z(i); })
        .attr("transform", function(d, i) { return "translate(" + x1(i) + ",0)"; })
    		.attr("id",function(d){return d.key})
      .selectAll("rect")
        .data(by_year)
      .enter().append("rect")
        .attr("width", x1.bandwidth())
        .attr("height", function(d){return y(d.sumPrice)})
        .attr("x", function(d, i) { return x0(i); })
        .attr("y", function(d) { return  offset_up- y(d.sumPrice); });

    
    })
    
  </script>
</body>
